<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add Items | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --danger: #ef4444;
            --excel-border: #cbd5e1;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%);
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        .navbar { height: 56px; background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        .nav-logo-text { color: white; font-weight: 800; font-size: 1rem; text-transform: uppercase; }
        .user-tag { color: var(--success); font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }

        .main-content { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }

        .bulk-container {
            background: white; border: 2px solid var(--primary); border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .bulk-header {
            padding: 12px; border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; background: #f8fafc;
            flex-shrink: 0;
        }
        .bulk-header h2 { margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); }

        .grid-area { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; position: relative; }
        
        table { border-collapse: collapse; width: 100%; min-width: 1100px; table-layout: fixed; }
        
        thead th { 
            position: sticky; top: 0; background: #f1f5f9; 
            font-size: 0.65rem; font-weight: 800; 
            border-bottom: 2px solid var(--primary); border-right: 1px solid var(--excel-border);
            text-transform: uppercase; color: #475569; z-index: 20; 
            height: 45px; padding: 0 10px;
        }

        .sticky-action { position: sticky !important; left: 0; z-index: 36 !important; width: 40px !important; background: #f1f5f9 !important; border-right: 1px solid var(--excel-border); text-align: center; }
        .sticky-num { position: sticky !important; left: 40px; z-index: 35 !important; width: 45px !important; background: #f1f5f9 !important; border-right: 2px solid var(--primary) !important; text-align: center; }

        tbody td { border-bottom: 1px solid var(--excel-border); border-right: 1px solid var(--excel-border); height: 48px; }

        input, select {
            width: 100%; height: 100%; padding: 0 8px; border: none; outline: none;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            background: transparent;
        }

        .sku-cell-input { font-family: monospace; color: var(--accent); font-weight: 800; text-align: center; background: #f8fafc !important; }

        .bulk-footer {
            padding: 10px; border-top: 2px solid var(--primary);
            display: flex; align-items: center; gap: 6px;
            background: white; flex-shrink: 0;
        }

        .btn {
            height: 44px; border-radius: 8px; font-weight: 800; 
            text-transform: uppercase; font-size: 0.65rem; cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
        }
        .btn-import { background: var(--success); color: white; padding: 0 12px; }
        .btn-add { background: #f1f5f9; color: var(--primary); border: 1px solid var(--excel-border); width: 100px; }
        .btn-save { background: var(--primary); color: white; flex: 1; font-size: 0.75rem; }
        .btn-back { background: #64748b; color: white; width: 160px; }
        
        #excel-upload { display: none; }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-logo-text">EasiStock Add items</div>
    <div class="user-tag"><div class="dot"></div><span id="display-user">STAFF</span></div>
</header>

<main class="main-content">
    <div class="bulk-container">
        <div class="bulk-header">
            <h2>Batch Entry</h2>
            <div>
                <label for="excel-upload" class="btn btn-import">üìÅ <span class="btn-text">Import Excel</span></label>
                <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" onchange="handleExcel(event)">
            </div>
        </div>

        <div class="grid-area">
            <table>
                <thead>
                    <tr>
                        <th class="sticky-action">DEL</th>
                        <th class="sticky-num">#</th>
                        <th style="width: 300px;">Description</th>
                        <th style="width: 130px;">Brand</th>
                        <th style="width: 160px;">Category</th>
                        <th style="width: 160px;">Generated SKU</th>
                        <th style="width: 100px;">UOM</th>
                        <th style="width: 150px;">Location</th>
                    </tr>
                </thead>
                <tbody id="bulk-body"></tbody>
            </table>
        </div>

        <div class="bulk-footer">
            <a href="dashboard.html" class="btn btn-back">EXIT TO DASHBOARD</a>
            <button class="btn btn-save" id="save-btn" onclick="saveAllItems()">Register All Items</button>
            <button class="btn btn-add" onclick="addNewRow()">+ Add Row</button>
        </div>
    </div>
</main>

<script>
    const SUPABASE_URL = 'https://crruounuhtfzyssyhgcc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let categories = [], uomList = [], locList = [];

    async function init() {
        const activeUser = localStorage.getItem('activeAdmin') || 'STAFF';
        document.getElementById('display-user').innerText = activeUser.toUpperCase();

        const { data: catData } = await _supabase.from('inventory_categories').select('*').order('name');
        categories = catData || [];
        const { data: uomData } = await _supabase.from('inventory_uom').select('name').order('name');
        uomList = uomData || [];
        const { data: locData } = await _supabase.from('inventory_locations').select('name').order('name');
        locList = locData || [];

        for(let i=0; i<8; i++) addNewRow();
    }

    function addNewRow(initialData = {}) {
        const tbody = document.getElementById('bulk-body');
        const tr = document.createElement('tr');
        
        const catOpts = categories.map(c => `<option value="${c.name}" data-code="${c.code}" ${initialData.category === c.name ? 'selected' : ''}>${c.name.toUpperCase()}</option>`).join('');
        const uomOpts = uomList.map(u => `<option value="${u.name}" ${initialData.uom === u.name ? 'selected' : ''}>${u.name.toUpperCase()}</option>`).join('');
        const locOpts = locList.map(l => `<option value="${l.name}" ${initialData.location === l.name ? 'selected' : ''}>${l.name.toUpperCase()}</option>`).join('');

        tr.innerHTML = `
            <td class="sticky-action"><button onclick="this.closest('tr').remove(); updateRowNumbers();" style="color:var(--danger); border:none; background:none; font-weight:900;">‚úï</button></td>
            <td class="sticky-num">0</td>
            <td><input type="text" class="row-name" value="${initialData.item_name || ''}" placeholder="NAME"></td>
            <td><input type="text" class="row-brand" value="${initialData.brand || ''}" placeholder="BRAND"></td>
            <td><select class="row-cat" onchange="generateRowSKU(this)"><option value="">--</option>${catOpts}</select></td>
            <td><input type="text" class="row-sku sku-cell-input" readonly value="${initialData.sku || '---'}"></td>
            <td><select class="row-uom"><option value="PCS">PCS</option>${uomOpts}</select></td>
            <td><select class="row-loc"><option value="MAIN">MAIN</option>${locOpts}</select></td>
        `;
        tbody.appendChild(tr);
        updateRowNumbers();
    }

    function updateRowNumbers() {
        document.querySelectorAll('#bulk-body tr').forEach((row, i) => row.querySelector('.sticky-num').innerText = i + 1);
    }

    function generateRowSKU(selectEl) {
        const prefix = selectEl.options[selectEl.selectedIndex].dataset.code || 'ITEM';
        const sku = `${prefix}-${new Date().getFullYear().toString().slice(-2)}-${Math.floor(1000 + Math.random() * 9000)}`;
        selectEl.closest('tr').querySelector('.row-sku').value = sku;
    }

    function handleExcel(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            document.getElementById('bulk-body').innerHTML = '';
            sheet.forEach(item => addNewRow({ item_name: item.Description, brand: item.Brand, category: item.Category, uom: item.UOM, location: item.Location }));
        };
        reader.readAsArrayBuffer(event.target.files[0]);
    }

    async function saveAllItems() {
        const rows = document.querySelectorAll('#bulk-body tr');
        const activeUser = document.getElementById('display-user').innerText;
        const items = [], trans = [];
        const ref = "NEW-" + Date.now().toString().slice(-6);

        rows.forEach(row => {
            const name = row.querySelector('.row-name').value.trim().toUpperCase();
            const sku = row.querySelector('.row-sku').value;
            if (name && sku !== "---") {
                items.push({ item_name: name, brand: row.querySelector('.row-brand').value.toUpperCase(), category: row.querySelector('.row-cat').value, sku: sku, uom: row.querySelector('.row-uom').value, location: row.querySelector('.row-loc').value, quantity: 0 });
                trans.push({ reference_id: ref, sku: sku, item_name: name, qty_change: 0, location: row.querySelector('.row-loc').value, notes: 'INITIAL REGISTRATION' });
            }
        });

        if (!items.length) return alert("No valid items.");
        document.getElementById('save-btn').disabled = true;

        try {
            await _supabase.from('inventory').insert(items);
            await _supabase.from('inventory_transactions').insert(trans);
            await _supabase.from('activity_logs').insert([{ type: 'ADD', reference_id: ref, performed_by: activeUser, summary: `REGISTERED ${items.length} NEW ITEMS` }]);
            
            alert("REGISTRATION SUCCESSFUL");
            window.location.href = 'inventory.html';
        } catch (e) { alert(e.message); document.getElementById('save-btn').disabled = false; }
    }

    window.onload = init;
</script>
</body>
</html>