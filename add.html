<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add Items | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --danger: #ef4444;
            --border-main: #cbd5e1;
            --sidebar-width-desktop: 110px;
        }

        /* --- GLOBAL LAYOUT --- */
        html, body { height: 100dvh; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%); display: flex; flex-direction: column; }

        .navbar { height: 60px; background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 1000; }
        .nav-title { color: white; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-info { display: flex; flex-direction: column; align-items: flex-end; margin-right: 10px; }
        .user-label { font-size: 0.5rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; }
        .user-name { font-size: 0.7rem; color: white; font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .online-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }

        .main-content { flex: 1; display: flex; flex-direction: column; padding: 8px; overflow: hidden; gap: 8px; }

        /* --- SIDEBAR / TOGGLE NAV --- */
        .action-bar-container { display: flex; justify-content: center; flex-shrink: 0; }
        .toggle-group { display: flex; width: 100%; max-width: 550px; border-radius: 10px; overflow: hidden; border: 2px solid var(--primary); background: var(--primary); }
        .btn-toggle { flex: 1; padding: 8px 0; border: none; border-right: 1px solid rgba(255,255,255,0.15); cursor: pointer; color: rgba(255,255,255,0.6); background: var(--primary); font-size: 0.6rem; font-weight: 800; text-transform: uppercase; display: none; flex-direction: column; align-items: center; gap: 2px; }
        .btn-toggle.active { background: var(--accent) !important; color: white !important; display: flex !important; }

        /* --- BULK ENTRY CARD --- */
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .bulk-card { background: white; border-radius: 12px; border: 2px solid var(--primary); display: flex; flex-direction: column; height: 100%; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .bulk-header { padding: 10px; border-bottom: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; flex-shrink: 0; }
        .bulk-header h2 { margin: 0; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--primary); }

        .grid-area { flex: 1; overflow: auto; background: #fff; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; width: 100%; min-width: 1100px; table-layout: fixed; }
        
        thead th { position: sticky; top: 0; background: #f1f5f9; font-size: 0.6rem; font-weight: 800; border-bottom: 2px solid var(--primary); border-right: 1px solid var(--border-main); text-transform: uppercase; z-index: 20; height: 40px; }
        .sticky-action { position: sticky !important; left: 0; z-index: 30; width: 45px !important; background: #f1f5f9; border-right: 1px solid var(--border-main); text-align: center; }
        .sticky-num { position: sticky !important; left: 45px; z-index: 29; width: 40px !important; background: #f1f5f9; border-right: 2px solid var(--primary); text-align: center; }

        tbody td { border-bottom: 1px solid var(--border-main); border-right: 1px solid var(--border-main); height: 44px; }
        input, select { width: 100%; height: 100%; padding: 0 8px; border: none; outline: none; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; background: transparent; }
        .price-input { color: var(--success); text-align: right; font-family: monospace; }

        /* --- MOBILE-FIXED FOOTER --- */
        .bulk-footer { padding: 8px; border-top: 2px solid var(--primary); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; flex-shrink: 0; }
        .btn-save { grid-column: span 2; order: -1; } 

        .btn { height: 40px; border-radius: 8px; font-weight: 800; text-transform: uppercase; font-size: 0.65rem; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }
        .btn-import { background: var(--success); color: white; padding: 0 10px; }
        .btn-add-row { background: #f1f5f9; color: var(--primary); border: 1.5px solid var(--primary); }
        .btn-save { background: var(--primary); color: white; font-size: 0.75rem; box-shadow: 0 3px 0 #000; }
        .btn-exit { background: #64748b; color: white; }

        /* --- DESKTOP VIEW ADJUSTMENTS --- */
        @media (min-width: 1024px) {
            .main-content { flex-direction: row; padding: 0; gap: 0; }
            .right-panel { order: 1; padding: 20px; }
            .action-bar-container { order: 2; width: var(--sidebar-width-desktop); height: 100%; background: var(--primary); flex-direction: column; border-left: 2px solid rgba(255,255,255,0.1); }
            .toggle-group { flex-direction: column; height: 100%; border-radius: 0; border: none; }
            .btn-toggle { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 30px 5px; width: 100%; display: flex; }
            .btn-toggle span:first-child { font-size: 1.5rem; }
            .btn-toggle span:last-child { font-size: 0.6rem; opacity: 1; transform: none; margin-top: 4px; }
            
            .bulk-footer { grid-template-columns: 160px 1fr 160px; padding: 15px 20px; }
            .btn-save { grid-column: unset; order: 0; height: 46px; }
            .btn { height: 46px; font-size: 0.75rem; }
        }
        
        #excel-upload { display: none; }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-title">EasiStock | Add Items</div>
    <div style="display:flex; align-items:center;">
        <div class="user-info">
            <span class="user-label">New Registration</span>
            <span class="user-name"><div class="online-dot"></div><span id="display-user">STAFF</span></span>
        </div>
    </div>
</header>

<main class="main-content">
    <div class="action-bar-container">
        <div class="toggle-group" id="perm-nav">
            <button class="btn-toggle active" data-page="inventory.html" onclick="location.href='inventory.html'"><span>üìã</span><span>Inventory</span></button>
            <button class="btn-toggle" data-page="receiving.html" onclick="location.href='receiving.html'"><span>üöö</span><span>Receiving</span></button>
            <button class="btn-toggle" data-page="orders.html" onclick="location.href='orders.html'"><span>üí∞</span><span>Sales</span></button>
            <button class="btn-toggle" data-page="transfer.html" onclick="location.href='transfer.html'"><span>üîÑ</span><span>Transfer</span></button>
            <button class="btn-toggle" data-page="return.html" onclick="location.href='return.html'"><span>‚Ü©Ô∏è</span><span>Return</span></button>
        </div>
    </div>

    <div class="right-panel">
        <div class="bulk-card">
            <div class="bulk-header">
                <h2>Batch Entry</h2>
                <div>
                    <label for="excel-upload" class="btn btn-import">üìÅ Excel Import</label>
                    <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" onchange="handleExcel(event)">
                </div>
            </div>

            <div class="grid-area">
                <table>
                    <thead>
                        <tr>
                            <th class="sticky-action">Del</th>
                            <th class="sticky-num">#</th>
                            <th style="width: 300px;">Description</th>
                            <th style="width: 130px;">Brand</th>
                            <th style="width: 160px;">Category</th>
                            <th style="width: 160px;">SKU</th>
                            <th style="width: 120px;">Price</th>
                            <th style="width: 80px;">UOM</th>
                            <th style="width: 120px;">Loc</th>
                        </tr>
                    </thead>
                    <tbody id="bulk-body"></tbody>
                </table>
            </div>

            <div class="bulk-footer">
                <button class="btn btn-exit" onclick="location.href='inventory.html'">Cancel</button>
                <button class="btn btn-add-row" onclick="addNewRow()">+ Add Row</button>
                <button class="btn btn-save" id="save-btn" onclick="saveAllItems()">Register All Items</button>
            </div>
        </div>
    </div>
</main>

<script>
    const _supabase = supabase.createClient('https://crruounuhtfzyssyhgcc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg');

    let categories = [], uomList = [], locList = [];

    async function init() {
        const activeUser = localStorage.getItem('activeAdmin') || 'STAFF';
        document.getElementById('display-user').innerText = activeUser.toUpperCase();

        const { data: catData } = await _supabase.from('inventory_categories').select('*').order('name');
        categories = catData || [];
        const { data: uomData } = await _supabase.from('inventory_uom').select('name').order('name');
        uomList = uomData || [];
        const { data: locData } = await _supabase.from('inventory_locations').select('name').order('name');
        locList = locData || [];

        for(let i=0; i<8; i++) addNewRow();
        applyPermissions();
    }

    function applyPermissions() {
        const userRole = localStorage.getItem('userRole');
        const userPermissions = JSON.parse(localStorage.getItem('userPermissions') || '[]');
        document.querySelectorAll('.btn-toggle').forEach(btn => {
            const page = btn.getAttribute('data-page');
            if (userRole === 'admin' || userPermissions.includes(page)) {
                btn.style.display = 'flex';
            }
        });
    }

    function addNewRow(initialData = {}) {
        const tbody = document.getElementById('bulk-body');
        const tr = document.createElement('tr');
        const catOpts = categories.map(c => `<option value="${c.name}" data-code="${c.code}" ${initialData.category === c.name ? 'selected' : ''}>${c.name.toUpperCase()}</option>`).join('');
        const uomOpts = uomList.map(u => `<option value="${u.name}" ${initialData.uom === u.name ? 'selected' : ''}>${u.name.toUpperCase()}</option>`).join('');
        const locOpts = locList.map(l => `<option value="${l.name}" ${initialData.location === l.name ? 'selected' : ''}>${l.name.toUpperCase()}</option>`).join('');

        tr.innerHTML = `
            <td class="sticky-action"><button onclick="this.closest('tr').remove(); updateRowNumbers();" style="color:var(--danger); border:none; background:none; font-weight:900; cursor:pointer;">‚úï</button></td>
            <td class="sticky-num">0</td>
            <td><input type="text" class="row-name" value="${initialData.item_name || ''}" placeholder="NAME"></td>
            <td><input type="text" class="row-brand" value="${initialData.brand || ''}" placeholder="BRAND"></td>
            <td><select class="row-cat" onchange="generateRowSKU(this)"><option value="">--</option>${catOpts}</select></td>
            <td><input type="text" class="row-sku sku-cell-input" readonly value="${initialData.sku || '---'}"></td>
            <td><input type="number" class="row-price price-input" value="${initialData.price || ''}" placeholder="0.00" step="0.01"></td>
            <td><select class="row-uom"><option value="PCS">PCS</option>${uomOpts}</select></td>
            <td><select class="row-loc"><option value="MAIN">MAIN</option>${locOpts}</select></td>
        `;
        tbody.appendChild(tr);
        updateRowNumbers();
    }

    function updateRowNumbers() {
        document.querySelectorAll('#bulk-body tr').forEach((row, i) => row.querySelector('.sticky-num').innerText = i + 1);
    }

    function generateRowSKU(selectEl) {
        const prefix = selectEl.options[selectEl.selectedIndex].dataset.code || 'ITEM';
        const sku = `${prefix}-${new Date().getFullYear().toString().slice(-2)}-${Math.floor(1000 + Math.random() * 9000)}`;
        selectEl.closest('tr').querySelector('.row-sku').value = sku;
    }

    function handleExcel(event) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            document.getElementById('bulk-body').innerHTML = '';
            sheet.forEach(item => addNewRow({ 
                item_name: item.Description || item.item_name, 
                brand: item.Brand || item.brand, 
                category: item.Category || item.category, 
                price: item.Price || item.price,
                uom: item.UOM || item.uom, 
                location: item.Location || item.location 
            }));
        };
        reader.readAsArrayBuffer(event.target.files[0]);
    }

    async function saveAllItems() {
        const rows = document.querySelectorAll('#bulk-body tr');
        const activeUser = document.getElementById('display-user').innerText;
        const items = [], trans = [];
        const ref = "REG-" + Date.now().toString().slice(-6);

        rows.forEach(row => {
            const name = row.querySelector('.row-name').value.trim().toUpperCase();
            const sku = row.querySelector('.row-sku').value;
            const price = parseFloat(row.querySelector('.row-price').value) || 0;
            if (name && sku !== "---") {
                items.push({ 
                    item_name: name, 
                    brand: row.querySelector('.row-brand').value.toUpperCase(), 
                    category: row.querySelector('.row-cat').value, 
                    sku: sku, 
                    price: price,
                    uom: row.querySelector('.row-uom').value, 
                    location: row.querySelector('.row-loc').value, 
                    quantity: 0 
                });
                trans.push({ 
                    reference_id: ref, 
                    sku: sku, 
                    item_name: name, 
                    qty_change: 0, 
                    location: row.querySelector('.row-loc').value, 
                    notes: 'REGISTRATION' 
                });
            }
        });

        if (!items.length) return alert("Fill in details first.");
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "SAVING...";

        try {
            await _supabase.from('inventory').insert(items);
            await _supabase.from('inventory_transactions').insert(trans);
            await _supabase.from('activity_logs').insert([{ type: 'ADD', reference_id: ref, performed_by: activeUser, summary: `REGISTERED ${items.length} ITEMS` }]);
            alert("SUCCESS");
            window.location.href = 'inventory.html';
        } catch (e) { alert(e.message); btn.disabled = false; btn.innerText = "Register All Items"; }
    }

    window.onload = init;
</script>
</body>
</html>