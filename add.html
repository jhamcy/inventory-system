<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add Items | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --danger: #ef4444;
            --excel-border: #cbd5e1;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%);
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        .navbar { height: 56px; background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; }
        .nav-logo-text { color: white; font-weight: 800; font-size: 1rem; text-transform: uppercase; }
        .user-tag { color: var(--success); font-size: 0.65rem; font-weight: 800; display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }

        .main-content { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }

        .bulk-container {
            background: white; border: 2px solid var(--primary); border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .bulk-header {
            padding: 12px; border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; background: #f8fafc;
            flex-shrink: 0;
        }
        .bulk-header h2 { margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); }

        .grid-area { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; position: relative; }
        
        table { border-collapse: collapse; width: 100%; min-width: 1100px; table-layout: fixed; }
        
        thead th { 
            position: sticky; top: 0; background: #f1f5f9; 
            font-size: 0.65rem; font-weight: 800; 
            border-bottom: 2px solid var(--primary); border-right: 1px solid var(--excel-border);
            text-transform: uppercase; color: #475569; z-index: 20; 
            height: 45px; padding: 0 10px;
        }

        .resizer {
            position: absolute; right: 0; top: 0; height: 100%; width: 6px;
            cursor: col-resize; user-select: none;
        }

        .sticky-action { position: sticky !important; left: 0; z-index: 36 !important; width: 40px !important; background: #f1f5f9 !important; border-right: 1px solid var(--excel-border); text-align: center; }
        .sticky-num { position: sticky !important; left: 40px; z-index: 35 !important; width: 45px !important; background: #f1f5f9 !important; border-right: 2px solid var(--primary) !important; text-align: center; }

        tbody td { border-bottom: 1px solid var(--excel-border); border-right: 1px solid var(--excel-border); height: 48px; }

        .col-desc { width: 300px; }
        .col-brand { width: 130px; }
        .col-cat { width: 160px; }
        .col-sku { width: 160px; }
        .col-uom { width: 100px; }
        .col-loc { width: 150px; }

        input, select {
            width: 100%; height: 100%; padding: 0 8px; border: none; outline: none;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            background: transparent;
        }

        .btn-remove { color: var(--danger); font-weight: 900; cursor: pointer; border: none; background: none; width: 100%; height: 100%; }

        .sku-cell-input { font-family: monospace; color: var(--accent); font-weight: 800; text-align: center; background: #f8fafc !important; }

        .bulk-footer {
            padding: 10px; border-top: 2px solid var(--primary);
            display: flex; align-items: center; gap: 6px;
            background: white; flex-shrink: 0;
        }

        .btn {
            height: 44px; border-radius: 8px; font-weight: 800; 
            text-transform: uppercase; font-size: 0.65rem; cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center; text-decoration: none;
        }
        .btn-import { background: var(--success); color: white; padding: 0 12px; }
        .btn-add { background: #f1f5f9; color: var(--primary); border: 1px solid var(--excel-border); width: 100px; }
        .btn-save { background: var(--primary); color: white; flex: 1; font-size: 0.75rem; }
        
        /* EXIT BUTTON: UPDATED TO DASHBOARD.HTML */
        .btn-back { background: var(--danger); color: white; width: 55px; }
        
        #excel-upload { display: none; }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-logo-text">EasiStock Add items</div>
    <div class="user-tag"><div class="dot"></div><span id="display-user">STAFF</span></div>
</header>

<main class="main-content">
    <div class="bulk-container">
        <div class="bulk-header">
            <h2>Batch Entry</h2>
            <div>
                <label for="excel-upload" class="btn btn-import">üìÅ <span class="btn-text">Import Excel</span></label>
                <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" onchange="handleExcel(event)">
            </div>
        </div>

        <div class="grid-area">
            <table id="resizeTable">
                <thead>
                    <tr>
                        <th class="sticky-action">DEL</th>
                        <th class="sticky-num">#</th>
                        <th class="col-desc">Description<div class="resizer"></div></th>
                        <th class="col-brand">Brand<div class="resizer"></div></th>
                        <th class="col-cat">Category<div class="resizer"></div></th>
                        <th class="col-sku">Generated SKU<div class="resizer"></div></th>
                        <th class="col-uom">UOM<div class="resizer"></div></th>
                        <th class="col-loc">Location<div class="resizer"></div></th>
                    </tr>
                </thead>
                <tbody id="bulk-body"></tbody>
            </table>
        </div>

        <div class="bulk-footer">
            <a href="dashboard.html" class="btn btn-back">EXIT</a>
            <button class="btn btn-save" id="save-btn" onclick="saveAllItems()">Register All Items</button>
            <button class="btn btn-add" onclick="addNewRow()">+ Add Row</button>
        </div>
    </div>
</main>

<script>
    const SUPABASE_URL = 'https://crruounuhtfzyssyhgcc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg';
    
    let _supabase;
    let categories = [], uomList = [], locList = [];

    async function init() {
        if (typeof supabase !== 'undefined') {
            _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            alert("Library Error: Supabase failed to load.");
            return;
        }

        const activeUser = localStorage.getItem('activeAdmin') || 'STAFF';
        document.getElementById('display-user').innerText = activeUser.toUpperCase();

        try {
            const { data: catData } = await _supabase.from('inventory_categories').select('*').order('name');
            categories = catData || [];
            const { data: uomData } = await _supabase.from('inventory_uom').select('name').order('name');
            uomList = uomData || [];
            const { data: locData } = await _supabase.from('inventory_locations').select('name').order('name');
            locList = locData || [];

            for(let i=0; i<10; i++) addNewRow();
            initResizer();
        } catch (error) {
            console.error("Initialization Error:", error);
        }
    }

    function initResizer() {
        const table = document.getElementById('resizeTable');
        const cols = table.querySelectorAll('th');
        cols.forEach(col => {
            const resizer = col.querySelector('.resizer');
            if (!resizer) return;
            let startX, startWidth;
            resizer.addEventListener('mousedown', (e) => {
                startX = e.pageX; startWidth = col.offsetWidth;
                const onMouseMove = (e) => {
                    const width = startWidth + (e.pageX - startX);
                    if (width > 50) col.style.width = width + 'px';
                };
                const onMouseUp = () => {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    }

    function addNewRow(initialData = {}) {
        const tbody = document.getElementById('bulk-body');
        const tr = document.createElement('tr');
        
        let catOptions = `<option value="">-- SELECT --</option>`;
        categories.forEach(c => {
            const selected = (initialData.category && initialData.category.toUpperCase() === c.name.toUpperCase()) ? 'selected' : '';
            catOptions += `<option value="${c.name}" data-code="${c.code}" ${selected}>${c.name.toUpperCase()}</option>`;
        });

        let uomOptions = `<option value="">--</option>`;
        uomList.forEach(u => {
            const unitName = u.name.toUpperCase();
            const isSelected = initialData.uom && initialData.uom.toUpperCase() === unitName ? 'selected' : '';
            uomOptions += `<option value="${unitName}" ${isSelected}>${unitName}</option>`;
        });

        let locOptions = `<option value="">--</option>`;
        locList.forEach(l => {
            const locName = l.name.toUpperCase();
            const isSelected = initialData.location && initialData.location.toUpperCase() === locName ? 'selected' : '';
            locOptions += `<option value="${locName}" ${isSelected}>${locName}</option>`;
        });

        tr.innerHTML = `
            <td class="sticky-action"><button class="btn-remove" onclick="removeRow(this)">‚úï</button></td>
            <td class="sticky-num" style="color:#94a3b8; font-weight:800; font-size:0.6rem;">0</td>
            <td><input type="text" class="row-name" value="${initialData.item_name || ''}" placeholder="DESCRIPTION"></td>
            <td><input type="text" class="row-brand" value="${initialData.brand || ''}" placeholder="BRAND"></td>
            <td><select class="row-cat" onchange="generateRowSKU(this)">${catOptions}</select></td>
            <td><input type="text" class="row-sku sku-cell-input" readonly value="${initialData.sku || '---'}"></td>
            <td><select class="row-uom">${uomOptions}</select></td>
            <td><select class="row-loc">${locOptions}</select></td>
        `;
        tbody.appendChild(tr);
        updateRowNumbers();

        const select = tr.querySelector('.row-cat');
        if(select.value) generateRowSKU(select);
    }

    function removeRow(btn) {
        if (document.querySelectorAll('#bulk-body tr').length <= 1) return;
        btn.closest('tr').remove();
        updateRowNumbers();
    }

    function updateRowNumbers() {
        const rows = document.querySelectorAll('#bulk-body tr');
        rows.forEach((row, index) => { row.querySelector('.sticky-num').innerText = index + 1; });
    }

    function generateRowSKU(selectEl) {
        const tr = selectEl.closest('tr');
        const skuInput = tr.querySelector('.row-sku');
        const opt = selectEl.options[selectEl.selectedIndex];
        if (!opt.value) { skuInput.value = "---"; return; }
        const prefix = opt.dataset.code || 'ITEM';
        const year = new Date().getFullYear().toString().slice(-2);
        const random = Math.floor(1000 + Math.random() * 9000);
        skuInput.value = `${prefix}-${year}-${random}`;
    }

    function handleExcel(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            document.getElementById('bulk-body').innerHTML = '';
            jsonData.forEach(item => {
                addNewRow({
                    item_name: item.Description || item.description || '',
                    brand: item.Brand || item.brand || '',
                    category: item.Category || item.category || '',
                    uom: item.UOM || item.uom || '',
                    location: item.Location || item.location || ''
                });
            });
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveAllItems() {
        const rows = document.querySelectorAll('#bulk-body tr');
        const activeUser = (localStorage.getItem('activeAdmin') || 'STAFF').toUpperCase();
        const itemsToInsert = [];
        const logsToInsert = [];
        const batchRef = "ADD-" + Date.now().toString().slice(-6);

        rows.forEach(row => {
            const name = row.querySelector('.row-name').value.trim().toUpperCase();
            const sku = row.querySelector('.row-sku').value;
            const cat = row.querySelector('.row-cat').value;
            const uom = row.querySelector('.row-uom').value || 'PCS';
            const loc = row.querySelector('.row-loc').value || '-';

            if (name && sku !== "---" && cat) {
                itemsToInsert.push({
                    item_name: name,
                    brand: row.querySelector('.row-brand').value.trim().toUpperCase(),
                    category: cat,
                    sku: sku,
                    uom: uom,
                    location: loc,
                    quantity: 0
                });

                logsToInsert.push({
                    type: 'ADD',
                    item_name: name,
                    quantity: 0,
                    reference_id: batchRef,
                    details: `[BY: ${activeUser}] NEW ITEM REGISTERED (SKU: ${sku})`.toUpperCase()
                });
            }
        });

        if (itemsToInsert.length === 0) return alert("NO VALID DATA ENTERED.");
        
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "UPDATING...";

        try {
            const { error: invError } = await _supabase.from('inventory').insert(itemsToInsert);
            if (invError) throw invError;

            const { error: logError } = await _supabase.from('activity_logs').insert(logsToInsert);
            if (logError) console.warn("Log tracking failed.");

            alert(`SUCCESS: ${itemsToInsert.length} ITEMS REGISTERED BY ${activeUser}`);
            window.location.href = 'dashboard.html'; // UPDATED REDIRECT
        } catch (err) {
            alert("ERROR: " + err.message);
            btn.disabled = false; btn.innerText = "REGISTER ALL ITEMS";
        }
    }

    window.onload = init;
</script>
</body>
</html>