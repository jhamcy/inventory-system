<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Add Items | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --excel-border: #cbd5e1;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%);
            /* Using dvh to fix mobile address bar issues */
            height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        .navbar { 
            height: 56px; background: var(--primary); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; flex-shrink: 0;
        }
        .nav-logo-text { color: white; font-weight: 800; font-size: 1rem; text-transform: uppercase; }

        .main-content { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }

        .bulk-container {
            background: white; border: 2px solid var(--primary); border-radius: 12px;
            display: flex; flex-direction: column; height: 100%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .bulk-header {
            padding: 12px; border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; background: #f8fafc;
            flex-shrink: 0;
        }
        .bulk-header h2 { margin: 0; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); }

        .grid-area { flex: 1; overflow: auto; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; width: 100%; min-width: 900px; }
        
        thead th { 
            position: sticky; top: 0; background: #f1f5f9; 
            padding: 10px; font-size: 0.65rem; font-weight: 800; 
            border-bottom: 2px solid var(--primary); border-right: 1px solid var(--excel-border);
            text-transform: uppercase; color: #475569; z-index: 10;
        }

        tbody td { border-bottom: 1px solid var(--excel-border); border-right: 1px solid var(--excel-border); }

        input, select {
            width: 100%; padding: 12px 8px; border: none; outline: none;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
            box-sizing: border-box; background: transparent;
        }
        input:focus { background: #f0f9ff; }

        .sku-cell { font-family: monospace; color: var(--accent); background: #f8fafc; font-weight: 800; text-align: center; }

        .bulk-footer {
            padding: 12px; border-top: 2px solid var(--primary);
            display: flex; justify-content: space-between; gap: 8px;
            background: white; flex-shrink: 0;
        }

        .btn {
            padding: 0 15px; height: 44px; border-radius: 8px; font-weight: 800; 
            text-transform: uppercase; font-size: 0.7rem; cursor: pointer; border: none;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-import { background: var(--success); color: white; }
        .btn-add { background: #e2e8f0; color: var(--primary); }
        .btn-save { background: var(--primary); color: white; flex: 1; }
        .btn-back { background: #ef4444; color: white; text-decoration: none; }
        
        #excel-upload { display: none; }

        @media (max-width: 600px) {
            .btn-text { display: none; } /* Hides text on small screens to save space */
        }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-logo-text">EasiStock Add items</div>
    <div style="color: var(--success); font-size: 0.65rem; font-weight: 800;">ADMIN_MODE</div>
</header>

<main class="main-content">
    <div class="bulk-container">
        <div class="bulk-header">
            <h2>Batch Entry</h2>
            <div>
                <label for="excel-upload" class="btn btn-import">üìÅ <span class="btn-text">Import Excel</span></label>
                <input type="file" id="excel-upload" accept=".xlsx, .xls, .csv" onchange="handleExcel(event)">
            </div>
        </div>

        <div class="grid-area">
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>Description</th>
                        <th style="width: 120px;">Brand</th>
                        <th style="width: 150px;">Category</th>
                        <th style="width: 150px;">Generated SKU</th>
                        <th style="width: 70px;">UOM</th>
                        <th style="width: 90px;">Location</th>
                    </tr>
                </thead>
                <tbody id="bulk-body"></tbody>
            </table>
        </div>

        <div class="bulk-footer">
            <a href="dashboard.html" class="btn btn-back">EXIT</a>
            <button class="btn btn-add" onclick="addNewRow()">+ <span class="btn-text">Add Row</span></button>
            <button class="btn btn-save" id="save-btn" onclick="saveAllItems()">Register All Items</button>
        </div>
    </div>
</main>

<script>
    const SUPABASE_URL = 'https://crruounuhtfzyssyhgcc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let categories = [];

    async function init() {
        const { data } = await _supabase.from('inventory_categories').select('*').order('name');
        categories = data || [];
        for(let i=0; i<5; i++) addNewRow();
    }

    function addNewRow(initialData = {}) {
        const tbody = document.getElementById('bulk-body');
        const rowCount = tbody.children.length + 1;
        const tr = document.createElement('tr');
        
        let catOptions = `<option value="">-- SELECT --</option>`;
        categories.forEach(c => {
            const selected = (initialData.category && initialData.category.toUpperCase() === c.name.toUpperCase()) ? 'selected' : '';
            catOptions += `<option value="${c.name}" data-code="${c.code}" ${selected}>${c.name.toUpperCase()}</option>`;
        });

        tr.innerHTML = `
            <td style="text-align:center; font-weight:800; font-size:0.6rem; color:#94a3b8;">${rowCount}</td>
            <td><input type="text" class="row-name" value="${initialData.item_name || ''}" placeholder="DESCRIPTION"></td>
            <td><input type="text" class="row-brand" value="${initialData.brand || ''}" placeholder="BRAND"></td>
            <td><select class="row-cat" onchange="generateRowSKU(this)">${catOptions}</select></td>
            <td><input type="text" class="row-sku sku-cell" readonly value="${initialData.sku || '---'}"></td>
            <td><input type="text" class="row-uom" value="${initialData.uom || 'PCS'}" placeholder="PCS"></td>
            <td><input type="text" class="row-loc" value="${initialData.location || '-'}" placeholder="BIN"></td>
        `;
        tbody.appendChild(tr);

        const select = tr.querySelector('.row-cat');
        if(select.value) generateRowSKU(select);
    }

    function generateRowSKU(selectEl) {
        const tr = selectEl.closest('tr');
        const skuInput = tr.querySelector('.row-sku');
        const opt = selectEl.options[selectEl.selectedIndex];
        if (!opt.value) { skuInput.value = "---"; return; }

        const prefix = opt.dataset.code;
        const year = new Date().getFullYear().toString().slice(-2);
        const random = Math.floor(1000 + Math.random() * 9000);
        skuInput.value = `${prefix}-${year}-${random}`;
    }

    function handleExcel(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            document.getElementById('bulk-body').innerHTML = '';
            jsonData.forEach(item => {
                addNewRow({
                    item_name: item.Description || item.description || '',
                    brand: item.Brand || item.brand || '',
                    category: item.Category || item.category || '',
                    uom: item.UOM || item.uom || 'PCS',
                    location: item.Location || item.location || '-'
                });
            });
        };
        reader.readAsArrayBuffer(file);
    }

    async function saveAllItems() {
        const rows = document.querySelectorAll('#bulk-body tr');
        const itemsToInsert = [];

        rows.forEach(row => {
            const name = row.querySelector('.row-name').value.trim();
            const sku = row.querySelector('.row-sku').value;
            if (name && sku !== "---") {
                itemsToInsert.push({
                    item_name: name,
                    brand: row.querySelector('.row-brand').value.trim(),
                    category: row.querySelector('.row-cat').value,
                    sku: sku,
                    uom: row.querySelector('.row-uom').value.trim() || 'PCS',
                    location: row.querySelector('.row-loc').value.trim() || '-',
                    quantity: 0
                });
            }
        });

        if (itemsToInsert.length === 0) return alert("NO VALID DATA.");
        const btn = document.getElementById('save-btn');
        btn.disabled = true; btn.innerText = "SAVING...";

        try {
            const { error } = await _supabase.from('inventory').insert(itemsToInsert);
            if (error) throw error;
            alert(`SUCCESS: ${itemsToInsert.length} ITEMS ADDED.`);
            window.location.href = 'inventory.html';
        } catch (err) {
            alert("UPLOAD ERROR: " + err.message);
            btn.disabled = false; btn.innerText = "REGISTER ALL ITEMS";
        }
    }

    init();
</script>
</body>
</html>