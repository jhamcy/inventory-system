<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audit Logs | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-main: #cbd5e1;
            --sidebar-width-desktop: 110px;
        }

        /* --- GLOBAL LAYOUT --- */
        html, body { height: 100dvh; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%); display: flex; flex-direction: column; }

        .navbar { height: 60px; background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 1000; }
        .nav-title { color: white; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .user-info { display: flex; flex-direction: column; align-items: flex-end; margin-right: 10px; }
        .user-label { font-size: 0.5rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; }
        .user-name { font-size: 0.7rem; color: white; font-weight: 700; display: flex; align-items: center; gap: 4px; }
        .online-dot { width: 6px; height: 6px; background: var(--success); border-radius: 50%; }

        .main-content { flex: 1; display: flex; flex-direction: column; padding: 8px; overflow: hidden; gap: 8px; }

        /* --- SIDEBAR --- */
        .action-bar-container { display: flex; justify-content: center; flex-shrink: 0; }
        .toggle-group { display: flex; width: 100%; max-width: 550px; border-radius: 10px; overflow: hidden; border: 2px solid var(--primary); background: var(--primary); }
        .btn-toggle { flex: 1; padding: 8px 0; border: none; border-right: 1px solid rgba(255,255,255,0.15); cursor: pointer; color: rgba(255,255,255,0.6); background: var(--primary); font-size: 0.6rem; font-weight: 800; text-transform: uppercase; display: none; flex-direction: column; align-items: center; gap: 2px; }
        .btn-toggle.active { background: var(--accent) !important; color: white !important; display: flex !important; }

        /* --- CONTENT CARD --- */
        .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .log-card { background: white; border-radius: 12px; border: 2px solid var(--primary); display: flex; flex-direction: column; height: 100%; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .filter-area { padding: 12px; border-bottom: 2px solid var(--primary); background: #f8fafc; flex-shrink: 0; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .search-wrapper { grid-column: span 2; }
        
        .search-input, .type-select, .date-input { 
            width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border-main);
            font-size: 0.75rem; font-weight: 700; outline: none; background: #fff;
        }
        .search-input:focus { border-color: var(--accent); }

        .grid-area { flex: 1; overflow: auto; background: #fff; -webkit-overflow-scrolling: touch; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; table-layout: fixed; }
        
        thead th { position: sticky; top: 0; background: #f1f5f9; font-size: 0.6rem; font-weight: 800; border-bottom: 2px solid var(--primary); text-transform: uppercase; z-index: 20; height: 40px; padding: 0 10px; text-align: left; }

        tbody td { padding: 12px 10px; border-bottom: 1px solid var(--border-main); font-size: 0.7rem; font-weight: 600; vertical-align: top; }
        tbody tr:hover { background-color: #f8fafc; cursor: pointer; }

        .badge { padding: 4px 6px; border-radius: 4px; font-weight: 900; font-size: 0.55rem; color: white; text-transform: uppercase; display: inline-block; }
        .ref-id { color: var(--accent); font-weight: 800; font-family: monospace; font-size: 0.75rem; display: block; }
        .summary-text { font-size: 0.6rem; color: #64748b; font-weight: 500; display: block; margin-top: 4px; text-transform: uppercase; line-height: 1.2; }

        /* --- FOOTER --- */
        .bulk-footer { padding: 8px; border-top: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; background: white; flex-shrink: 0; }
        #log-count { font-size: 0.7rem; font-weight: 900; color: var(--accent); }
        
        .btn-back { height: 40px; background: var(--primary); color: white; border-radius: 8px; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none; font-size: 0.7rem; padding: 0 20px; text-decoration: none; display: flex; align-items: center; }

        /* --- DESKTOP VIEW --- */
        @media (min-width: 1024px) {
            .main-content { flex-direction: row; padding: 0; gap: 0; }
            .right-panel { order: 1; padding: 20px; }
            .action-bar-container { order: 2; width: var(--sidebar-width-desktop); height: 100%; background: var(--primary); flex-direction: column; }
            .toggle-group { flex-direction: column; height: 100%; border-radius: 0; border: none; }
            .btn-toggle { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 30px 5px; width: 100%; display: flex; }
            .btn-toggle span:first-child { font-size: 1.5rem; }
            
            .filter-grid { grid-template-columns: 2fr 1fr 1fr 1fr; }
            .search-wrapper { grid-column: span 1; }
        }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-title">Audit Master Log</div>
    <div class="user-info">
        <span class="user-label">Logged In As</span>
        <span class="user-name"><div class="online-dot"></div><span id="display-user">ADMIN</span></span>
    </div>
</header>

<main class="main-content">
    <div class="action-bar-container">
        <div class="toggle-group" id="perm-nav">
            <button class="btn-toggle active" data-page="inventory.html" onclick="location.href='inventory.html'"><span>üìã</span><span>Inventory</span></button>
            <button class="btn-toggle" data-page="receiving.html" onclick="location.href='receiving.html'"><span>üöö</span><span>Receiving</span></button>
            <button class="btn-toggle" data-page="orders.html" onclick="location.href='orders.html'"><span>üí∞</span><span>Sales</span></button>
            <button class="btn-toggle" data-page="transfer.html" onclick="location.href='transfer.html'"><span>üîÑ</span><span>Transfer</span></button>
            <button class="btn-toggle" data-page="return.html" onclick="location.href='return.html'"><span>‚Ü©Ô∏è</span><span>Return</span></button>
        </div>
    </div>

    <div class="right-panel">
        <div class="log-card">
            <div class="filter-area">
                <div class="filter-grid">
                    <div class="search-wrapper">
                        <input type="text" id="mainSearch" class="search-input" placeholder="üîç SEARCH REF OR NOTE..." onkeyup="applyFilters()">
                    </div>
                    <select id="typeFilter" class="type-select" onchange="applyFilters()">
                        <option value="ALL">ALL ACTIVITIES</option>
                        <option value="RECEIVING">üöö RECEIVING</option>
                        <option value="SALES">üí∞ SALES</option>
                        <option value="TRANSFER">üîÑ TRANSFERS</option>
                        <option value="RETURN">‚Ü©Ô∏è RETURNS</option>
                        <option value="EDIT">‚úèÔ∏è EDITS</option>
                        <option value="ADJUST">‚öñÔ∏è ADJUSTMENTS</option>
                        <option value="STATUS">üõ°Ô∏è STATUS</option>
                    </select>
                    <input type="date" id="dateFrom" class="date-input" onchange="applyFilters()">
                    <input type="date" id="dateTo" class="date-input" onchange="applyFilters()">
                </div>
            </div>

            <div class="grid-area">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 100px;">Date</th>
                            <th style="width: 110px;">Type</th>
                            <th>Reference & Summary</th>
                            <th style="width: 100px; text-align: right;">User</th>
                        </tr>
                    </thead>
                    <tbody id="logs-master-body">
                        <tr><td colspan="4" style="text-align:center; padding:40px; color:#94a3b8;">Fetching records...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="bulk-footer">
                <a href="dashboard.html" class="btn-back">EXIT LOGS</a>
                <div id="log-count">0 RECORDS FOUND</div>
                <button class="btn-back" style="background:#64748b;" onclick="resetFilters()">RESET</button>
            </div>
        </div>
    </div>
</main>

<script>
    const _supabase = supabase.createClient('https://crruounuhtfzyssyhgcc.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg');

    let masterLogData = [];

    async function init() {
        const activeUser = localStorage.getItem('activeAdmin') || 'STAFF';
        document.getElementById('display-user').innerText = activeUser.toUpperCase();
        applyPermissions();
        fetchLogs();
    }

    function applyPermissions() {
        const userRole = localStorage.getItem('userRole');
        const userPermissions = JSON.parse(localStorage.getItem('userPermissions') || '[]');
        document.querySelectorAll('.btn-toggle').forEach(btn => {
            const page = btn.getAttribute('data-page');
            if (userRole === 'admin' || userPermissions.includes(page)) {
                btn.style.display = 'flex';
            }
        });
    }

    async function fetchLogs() {
        const { data, error } = await _supabase
            .from('activity_logs')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) return;

        masterLogData = data.map(log => ({
            rawDate: log.created_at.split('T')[0],
            displayDate: new Date(log.created_at).toLocaleDateString('en-GB'),
            type: (log.type === 'ORDER' ? 'SALES' : (log.type || 'INFO')).toUpperCase(),
            ref: log.reference_id || '---',
            summary: log.summary || '',
            user: (log.performed_by || 'STAFF').toUpperCase()
        }));

        renderTable(masterLogData);
    }

    function renderTable(list) {
        const tbody = document.getElementById('logs-master-body');
        document.getElementById('log-count').innerText = `${list.length} RECORDS FOUND`;

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px;">No records match your filters.</td></tr>';
            return;
        }

        tbody.innerHTML = list.map(row => `
            <tr onclick="location.href='transaction.html?ref=${encodeURIComponent(row.ref)}'">
                <td style="color: #64748b; font-size: 0.65rem;">${row.displayDate}</td>
                <td><span class="badge" style="background:${getTypeColor(row.type)}">${row.type}</span></td>
                <td>
                    <span class="ref-id">${row.ref}</span>
                    <span class="summary-text">${row.summary}</span>
                </td>
                <td style="text-align:right; font-weight: 800; color: var(--primary);">${row.user}</td>
            </tr>
        `).join('');
    }

    function getTypeColor(type) {
        if (type.includes('RECEIVING')) return '#059669'; // Emerald
        if (type.includes('SALES') || type.includes('ORDER')) return '#6366f1'; // Indigo
        if (type.includes('TRANS')) return '#0ea5e9'; // Sky
        if (type.includes('RETURN')) return '#f59e0b'; // Amber
        if (type.includes('EDIT')) return '#8b5cf6'; // Violet
        if (type.includes('ADJUST')) return '#d946ef'; // Fuchsia
        if (type.includes('STATUS')) return '#f43f5e'; // Rose
        return '#64748b'; // Slate
    }

    function applyFilters() {
        const searchVal = document.getElementById('mainSearch').value.toUpperCase();
        const typeVal = document.getElementById('typeFilter').value;
        const fromVal = document.getElementById('dateFrom').value;
        const toVal = document.getElementById('dateTo').value;

        const filtered = masterLogData.filter(item => {
            const matchesSearch = item.ref.toUpperCase().includes(searchVal) || item.summary.toUpperCase().includes(searchVal);
            
            let matchesType = (typeVal === "ALL");
            if (!matchesType) {
                if (typeVal === "SALES") {
                    matchesType = (item.type === "SALES" || item.type === "ORDER");
                } else {
                    matchesType = item.type.includes(typeVal);
                }
            }

            let matchesDate = true;
            if (fromVal && item.rawDate < fromVal) matchesDate = false;
            if (toVal && item.rawDate > toVal) matchesDate = false;
            return matchesSearch && matchesType && matchesDate;
        });
        renderTable(filtered);
    }

    function resetFilters() {
        document.getElementById('mainSearch').value = '';
        document.getElementById('typeFilter').value = 'ALL';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        renderTable(masterLogData);
    }

    window.onload = init;
</script>
</body>
</html>