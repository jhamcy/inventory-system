<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Audit Logs | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0f172a;
            --accent: #0081ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --reorder: #f97316;
            --excel-border: #cbd5e1;
        }

        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%);
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
            align-items: center;
        }

        .navbar { 
            width: 100%; height: 60px; background: var(--primary); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; flex-shrink: 0; box-sizing: border-box;
        }

        .nav-logo-text { color: white; font-weight: 800; font-size: 1rem; text-transform: uppercase; }

        .btn-home {
            background: var(--accent); color: white; border: none; padding: 8px 15px;
            border-radius: 8px; font-weight: 800; font-size: 0.7rem; cursor: pointer;
            text-decoration: none; text-transform: uppercase;
        }

        .main-content { 
            width: 100%; max-width: 700px; flex: 1; padding: 10px; 
            display: flex; flex-direction: column; overflow: hidden;
            box-sizing: border-box;
        }

        .filter-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 6px; 
            margin-bottom: 10px; width: 100%; background: white;
            padding: 10px; border-radius: 12px; border: 2px solid var(--primary);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); box-sizing: border-box; 
            flex-shrink: 0; 
        }

        .search-wrapper { grid-column: span 2; }
        .search-input, .type-select, .date-input { 
            width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;
            font-size: 0.8rem; font-weight: 700; box-sizing: border-box; outline: none; background: #f8fafc;
        }

        .btn-reset { 
            grid-column: span 2; background: #64748b; color: white; border: none; 
            padding: 8px; border-radius: 8px; font-weight: 800; font-size: 0.65rem; 
            cursor: pointer; text-transform: uppercase; 
        }

        .section-header { 
            width: 100%; background: var(--primary); color: white; padding: 10px 15px; 
            border-radius: 12px 12px 0 0; font-size: 0.65rem; font-weight: 800; 
            text-transform: uppercase; display: flex; justify-content: space-between; 
            box-sizing: border-box; flex-shrink: 0;
        }

        .table-area { 
            width: 100%; background: white; border: 2px solid var(--primary); border-top: none; 
            border-radius: 0 0 12px 12px; overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1;
            -webkit-overflow-scrolling: touch;
        }
        
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }

        thead th { 
            position: sticky; top: 0; z-index: 10; background: #f1f5f9;
            padding: 10px; font-size: 0.55rem; text-transform: uppercase; 
            border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: 800; text-align: left;
        }

        tbody tr { cursor: pointer; }
        tbody tr:hover { background-color: #f8fafc; }

        tbody td { padding: 10px; border-bottom: 1px solid var(--excel-border); font-size: 0.7rem; font-weight: 600; vertical-align: middle; word-wrap: break-word; }

        .badge { 
            padding: 4px 2px; border-radius: 4px; font-weight: 800; font-size: 0.5rem; 
            color: white; text-align: center; display: block; width: 100%; box-sizing: border-box;
            text-transform: uppercase;
        }

        .ref-id { color: var(--accent); font-weight: 800; font-family: monospace; font-size: 0.7rem; }
        .summary-text { font-size: 0.55rem; color: #64748b; font-weight: 500; display: block; margin-top: 2px; text-transform: uppercase; }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="nav-logo-text">Audit Master Log</div>
        <a href="dashboard.html" class="btn-home">üè† Home</a>
    </header>

    <main class="main-content">
        <div class="filter-grid">
            <div class="search-wrapper">
                <input type="text" id="mainSearch" class="search-input" placeholder="üîç SEARCH REF OR NOTE..." onkeyup="applyFilters()">
            </div>
            <select id="typeFilter" class="type-select" onchange="applyFilters()">
                <option value="ALL">ALL ACTIVITIES</option>
                <option value="RECEIVING">üöö RECEIVING</option>
                <option value="SALES">üí∞ SALES</option>
                <option value="TRANSFER">üîÑ TRANSFERS</option>
                <option value="RETURN">‚Ü©Ô∏è RETURNS</option>
                <option value="REORDER">‚ö†Ô∏è PROCUREMENT</option> 
                <option value="EDIT">‚úèÔ∏è EDITS</option>
                <option value="ADJUST">‚öñÔ∏è ADJUSTMENTS</option>
            </select>
            <div style="display: flex; gap: 4px;">
                <input type="date" id="dateFrom" class="date-input" onchange="applyFilters()">
                <input type="date" id="dateTo" class="date-input" onchange="applyFilters()">
            </div>
            <button class="btn-reset" onclick="resetFilters()">Reset All Filters</button>
        </div>

        <div class="section-header">
            <span>üìë System History</span>
            <span id="log-count">0 RECORDS</span>
        </div>
        
        <div class="table-area">
            <table>
                <thead>
                    <tr>
                        <th style="width: 20%;">Date</th>
                        <th style="width: 25%;">Type</th>
                        <th style="width: 35%;">Ref / Note</th>
                        <th style="width: 20%; text-align: right;">User</th>
                    </tr>
                </thead>
                <tbody id="logs-master-body">
                    <tr><td colspan="4" style="text-align:center; padding:30px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://crruounuhtfzyssyhgcc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let masterLogData = [];

        async function fetchLogs() {
            const { data, error } = await _supabase
                .from('activity_logs')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) return;

            masterLogData = data.map(log => ({
                rawDate: log.created_at.split('T')[0],
                displayDate: new Date(log.created_at).toLocaleDateString('en-GB'),
                type: (log.type === 'ORDER' ? 'SALES' : (log.type || 'INFO')).toUpperCase(),
                ref: log.reference_id || '---',
                summary: log.summary || '',
                user: (log.performed_by || 'STAFF').toUpperCase()
            }));

            renderTable(masterLogData);
        }

        function renderTable(list) {
            const tbody = document.getElementById('logs-master-body');
            document.getElementById('log-count').innerText = `${list.length} RECORDS`;

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:30px;">No records.</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(row => `
                <tr onclick="location.href='transaction.html?ref=${encodeURIComponent(row.ref)}'">
                    <td style="font-size: 0.55rem; color: #64748b;">${row.displayDate}</td>
                    <td><span class="badge" style="background:${getTypeColor(row.type)}">${row.type}</span></td>
                    <td>
                        <span class="ref-id">${row.ref}</span>
                        <span class="summary-text">${row.summary}</span>
                    </td>
                    <td style="text-align:right; font-size: 0.55rem; color: var(--primary); font-weight: 800;">${row.user}</td>
                </tr>
            `).join('');
        }

        function getTypeColor(type) {
            if (type.includes('RECV') || type.includes('RECEIVING')) return '#059669'; // Green
            if (type.includes('SALES') || type.includes('ORDER')) return '#6366f1'; // Indigo
            if (type.includes('TRANS')) return '#0081ff'; // Blue
            if (type.includes('RTN') || type.includes('RETURN')) return '#f59e0b'; // Amber
            if (type.includes('REORDER') || type.includes('PROC')) return '#f97316'; // Orange
            if (type.includes('EDIT')) return '#8b5cf6'; // Purple
            return '#475569'; // Gray
        }

        function applyFilters() {
            const searchVal = document.getElementById('mainSearch').value.toUpperCase();
            const typeVal = document.getElementById('typeFilter').value;
            const fromVal = document.getElementById('dateFrom').value;
            const toVal = document.getElementById('dateTo').value;

            const filtered = masterLogData.filter(item => {
                const matchesSearch = item.ref.includes(searchVal) || item.summary.toUpperCase().includes(searchVal);
                
                // Special handling for Sales/Order filtering
                let matchesType = (typeVal === "ALL");
                if (!matchesType) {
                    if (typeVal === "SALES") {
                        matchesType = (item.type === "SALES" || item.type === "ORDER");
                    } else {
                        matchesType = item.type.includes(typeVal);
                    }
                }

                let matchesDate = true;
                if (fromVal && item.rawDate < fromVal) matchesDate = false;
                if (toVal && item.rawDate > toVal) matchesDate = false;
                return matchesSearch && matchesType && matchesDate;
            });
            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('mainSearch').value = '';
            document.getElementById('typeFilter').value = 'ALL';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            renderTable(masterLogData);
        }

        window.onload = fetchLogs;
    </script>
</body>
</html>