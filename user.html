<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Staff & Security | EasiStock</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        
        :root { 
            --primary: #0f172a; 
            --accent: #0081ff; 
            --danger: #ef4444; 
            --success: #10b981;
            --border-main: #cbd5e1;
            --sidebar-width: 110px;
        }

        /* --- GLOBAL LAYOUT --- */
        html, body { height: 100dvh; margin: 0; padding: 0; overflow: hidden; position: fixed; width: 100%; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, #6ecfff 0%, #3ca7e7 100%); display: flex; flex-direction: column; }

        .navbar { height: 60px; background: var(--primary); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; flex-shrink: 0; z-index: 1000; }
        .nav-title { color: white; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

        .main-content { flex: 1; display: flex; flex-direction: column; padding: 8px; overflow: hidden; gap: 8px; }

        /* --- SIDEBAR --- */
        .action-bar-container { display: flex; justify-content: center; flex-shrink: 0; }
        .toggle-group { display: flex; width: 100%; max-width: 550px; border-radius: 10px; overflow: hidden; border: 2px solid var(--primary); background: var(--primary); }
        .btn-toggle { flex: 1; padding: 8px 0; border: none; border-right: 1px solid rgba(255,255,255,0.15); cursor: pointer; color: rgba(255,255,255,0.6); background: var(--primary); font-size: 0.6rem; font-weight: 800; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .btn-toggle.active { background: var(--accent) !important; color: white !important; }

        /* --- CONTENT PANELS --- */
        .right-panel { flex: 1; display: grid; grid-template-columns: 1fr; gap: 10px; overflow: hidden; }
        @media (min-width: 1024px) {
            .right-panel { grid-template-columns: 350px 1fr; }
        }

        .card { background: white; border-radius: 12px; border: 2px solid var(--primary); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-header { padding: 12px; background: #f8fafc; border-bottom: 2px solid var(--primary); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--primary); }
        
        .scroll-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* --- FORM STYLES --- */
        .form-grid { display: flex; flex-direction: column; gap: 10px; }
        input, select { padding: 12px; border: 2px solid var(--border-main); border-radius: 8px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; outline: none; }
        input:focus { border-color: var(--accent); }

        .permission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; background: #f1f5f9; padding: 10px; border-radius: 8px; margin-top: 5px; }
        .perm-item { display: flex; align-items: center; gap: 6px; font-size: 0.55rem; font-weight: 800; color: var(--primary); background: white; padding: 8px; border-radius: 5px; border: 1px solid var(--border-main); cursor: pointer; }
        
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-save { background: var(--primary); color: white; }
        .btn-update { background: var(--accent); color: white; display: none; }
        .btn-cancel { background: #64748b; color: white; margin-top: 5px; }

        /* --- TABLE STYLES --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 600px; }
        thead th { position: sticky; top: 0; background: #f1f5f9; z-index: 10; padding: 12px; font-size: 0.6rem; border-bottom: 2px solid var(--primary); text-align: left; }
        tbody td { padding: 12px; border-bottom: 1px solid var(--border-main); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        tr:hover { background: #f0f9ff; cursor: pointer; }

        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.55rem; color: white; background: #64748b; }
        .role-admin { background: var(--danger); }
        .pass-code { font-family: monospace; color: var(--accent); letter-spacing: 1px; }

        /* --- DESKTOP VIEW --- */
        @media (min-width: 1024px) {
            .main-content { flex-direction: row; padding: 0; gap: 0; }
            .right-panel { order: 1; padding: 20px; }
            .action-bar-container { order: 2; width: var(--sidebar-width); height: 100%; background: var(--primary); flex-direction: column; }
            .toggle-group { flex-direction: column; height: 100%; border-radius: 0; border: none; }
            .btn-toggle { border-right: none; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 30px 5px; width: 100%; }
            .btn-toggle span:first-child { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<header class="navbar">
    <div class="nav-title">Security & Staff Management</div>
    <a href="dashboard.html" style="color:white; font-size:0.6rem; font-weight:800; text-decoration:none; border:2px solid white; padding:6px 12px; border-radius:6px;">EXIT TO DASH</a>
</header>

<main class="main-content">
    <div class="action-bar-container">
        <div class="toggle-group">
            <button class="btn-toggle" onclick="location.href='inventory.html'"><span>ðŸ“‹</span><span>Stock</span></button>
            <button class="btn-toggle" onclick="location.href='logs.html'"><span>ðŸ“œ</span><span>Logs</span></button>
            <button class="btn-toggle active"><span>ðŸ‘¥</span><span>Users</span></button>
        </div>
    </div>

    <div class="right-panel">
        <div class="card">
            <div class="card-header" id="form-title">Account Registration</div>
            <div class="scroll-body">
                <div class="form-grid">
                    <input type="text" id="id-in" placeholder="EMPLOYEE ID">
                    <input type="text" id="name-in" placeholder="FULL NAME">
                    <input type="text" id="user-in" placeholder="USERNAME">
                    <input type="text" id="pass-in" placeholder="PASSWORD">
                    
                    <select id="role-in">
                        <option value="staff">STAFF MEMBER</option>
                        <option value="admin">ADMINISTRATOR</option>
                    </select>
                    
                    <div style="font-size: 0.6rem; font-weight: 800; color: var(--accent); margin-top: 10px;">ACTION PRIVILEGES:</div>
                    <div class="permission-grid" id="perm-list">
                        <label class="perm-item"><input type="checkbox" value="perm_add"> ADD</label>
                        <label class="perm-item"><input type="checkbox" value="perm_edit"> EDIT</label>
                        <label class="perm-item"><input type="checkbox" value="perm_adj"> ADJ</label>
                        <label class="perm-item"><input type="checkbox" value="perm_delete"> DEL</label>
                        <label class="perm-item"><input type="checkbox" value="perm_logs"> LOGS</label>
                        <label class="perm-item"><input type="checkbox" value="perm_users"> MGMT</label>
                    </div>

                    <button id="btn-save" class="btn-action btn-save" onclick="saveUser()">Create Account</button>
                    <button id="btn-update" class="btn-action btn-update" onclick="updateUser()">Update Details</button>
                    <button id="btn-cancel" class="btn-action btn-cancel" onclick="resetForm()">Cancel</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Active Staff Directory</div>
            <div class="scroll-body" style="padding:0;">
                <table>
                    <thead>
                        <tr>
                            <th>STAFF ID</th>
                            <th>NAME</th>
                            <th>USER</th>
                            <th>PASS</th>
                            <th>ROLE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script>
    const _URL = 'https://crruounuhtfzyssyhgcc.supabase.co';
    const _KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNycnVvdW51aHRmenlzc3loZ2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEyMjc5NDgsImV4cCI6MjA4NjgwMzk0OH0.PMLb-8HZLdXUxXk2Jv0f836_YVWcaS3X2ezCvjfG6jg';
    const _sb = supabase.createClient(_URL, _KEY);
    let editingUser = null;

    async function loadTable() {
        const { data, error } = await _sb.from('staff_accounts').select('*').order('username');
        if(error) return;
        
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = data.map(u => `
            <tr onclick="activateEditMode(${JSON.stringify(u).replace(/"/g, '&quot;')})">
                <td style="color:#64748b;">#${u.staff_id || '---'}</td>
                <td>${u.full_name}</td>
                <td style="color:var(--accent); font-weight:800;">${u.username}</td>
                <td class="pass-code">${u.password}</td>
                <td><span class="role-badge ${u.role === 'admin' ? 'role-admin' : ''}">${u.role}</span></td>
                <td>
                    ${u.username !== 'ADMIN_MASTER' ? `<button style="color:var(--danger); background:none; border:none; font-weight:800; cursor:pointer;" onclick="event.stopPropagation(); delUser('${u.username}')">DEL</button>` : 'ðŸ”’'}
                </td>
            </tr>
        `).join('');
    }

    function activateEditMode(user) {
        editingUser = user.username;
        document.getElementById('form-title').innerText = "Edit: " + user.username;
        document.getElementById('id-in').value = user.staff_id || "";
        document.getElementById('name-in').value = user.full_name || "";
        document.getElementById('user-in').value = user.username;
        document.getElementById('user-in').disabled = true;
        document.getElementById('pass-in').value = user.password;
        document.getElementById('role-in').value = user.role;
        
        const userPerms = user.permissions || [];
        document.querySelectorAll('#perm-list input').forEach(cb => {
            cb.checked = userPerms.includes(cb.value);
        });
        
        document.getElementById('btn-save').style.display = 'none';
        document.getElementById('btn-update').style.display = 'block';
    }

    function resetForm() {
        editingUser = null;
        document.getElementById('form-title').innerText = "Account Registration";
        document.getElementById('user-in').disabled = false;
        document.querySelectorAll('input').forEach(i => i.value = "");
        document.querySelectorAll('#perm-list input').forEach(cb => cb.checked = false);
        document.getElementById('btn-save').style.display = 'block';
        document.getElementById('btn-update').style.display = 'none';
    }

    async function saveUser() {
        const payload = getFormData();
        if(!payload.username || !payload.password) return alert("Missing required fields");
        
        const { error } = await _sb.from('staff_accounts').insert([payload]);
        if(error) alert(error.message);
        else { resetForm(); loadTable(); }
    }

    async function updateUser() {
        const payload = getFormData();
        const { error } = await _sb.from('staff_accounts').update(payload).eq('username', editingUser);
        if(error) alert(error.message);
        else { resetForm(); loadTable(); }
    }

    function getFormData() {
        return {
            staff_id: document.getElementById('id-in').value.trim().toUpperCase(),
            full_name: document.getElementById('name-in').value.trim().toUpperCase(),
            username: document.getElementById('user-in').value.trim().toUpperCase(),
            password: document.getElementById('pass-in').value.trim(),
            role: document.getElementById('role-in').value,
            permissions: Array.from(document.querySelectorAll('#perm-list input:checked')).map(cb => cb.value)
        };
    }

    async function delUser(name) {
        if(!confirm(`Permanent delete for ${name}?`)) return;
        await _sb.from('staff_accounts').delete().eq('username', name);
        loadTable();
    }

    window.onload = loadTable;
</script>
</body>
</html>